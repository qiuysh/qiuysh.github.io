<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="操千曲而后晓声，观千剑而后识器。"><title>React 事件系统 | 吾林の手扎</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">React 事件系统</h1><a id="logo" href="/.">吾林の手扎</a><p class="description">操千曲而后晓声，观千剑而后识器。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">React 事件系统</h1><div class="post-meta">2021-09-13<span> | </span><span class="category"><a href="/categories/web%E6%8A%80%E6%9C%AF/">web技术</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 906</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 3</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><h3 id="零、从零开始"><a href="#零、从零开始" class="headerlink" title="零、从零开始"></a>零、从零开始</h3><p>在看下面 React 事件系统相关流程之前，我们先看看整个 React 渲染的大概流程；以便于后面更轻松地学习 React 事件系统相关概念。<br>下图大概是描述了不管 Mount 还是 Update 触发的行为到完成渲染，都会经历 Render 和 Commit 两个阶段，Render 阶段做的事情：根据优先级调度执行过程可打断、遍历Fiber树、Diff更新Fiber树等，Commit 阶段触发生命周期钩子，遍历Fiber完成渲染。</p>
<center><img src="react渲染流程.png" width="30%"/></center>

<h3 id="一、浏览器事件流"><a href="#一、浏览器事件流" class="headerlink" title="一、浏览器事件流"></a>一、浏览器事件流</h3><h5 id="DOM-事件流的三个阶段"><a href="#DOM-事件流的三个阶段" class="headerlink" title="DOM 事件流的三个阶段"></a>DOM 事件流的三个阶段</h5><p> 事件捕获阶段<br> 目标元素阶段<br> 事件冒泡阶段</p>
<h5 id="示意图"><a href="#示意图" class="headerlink" title="示意图"></a>示意图</h5><center><img src="dom事件流.png" width="60%" /></center>


<h3 id="二、React-事件系统"><a href="#二、React-事件系统" class="headerlink" title="二、React 事件系统"></a>二、React 事件系统</h3><p>合成事件的说明 React 并不会在该 DOM 元素上直接绑定事件处理器，React 内部自定义了一套事件系统，在这个系统上统一进行事件订阅和分发。<br>具体来讲，React 利用事件委托机制在 Root 容器上统一监听 DOM 事件，再根据触发的 target 将事件分发到具体的组件实例。另外上面 e 是一个合成事件对象( SyntheticEvent ), 而不是原始的 DOM 事件对象。</p>
<h5 id="为何要自定义事件系统"><a href="#为何要自定义事件系统" class="headerlink" title="为何要自定义事件系统"></a>为何要自定义事件系统</h5><p>根据 W3C 规范定义合成事件抹平浏览器之间的兼容性差异；<br>分成设计，解决跨平台问题；<br>干预事件触发，React 需要知道触发了什么事件，通过什么原生事件调用真实事件；<br>性能优化，避免事件直接绑定在dom上；</p>
<h3 id="三、事件流程浅析"><a href="#三、事件流程浅析" class="headerlink" title="三、事件流程浅析"></a>三、事件流程浅析</h3><p>React17事件系统架构图</p>
<center><img src="react事件系统.png" width="70%" /></center>

<h5 id="事件注册"><a href="#事件注册" class="headerlink" title="事件注册"></a>事件注册</h5><p>初始化形成必要的事件映射关系</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eventPriorities：原生事件及其优先级的映射 Map结构</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"click"</span> =&gt; <span class="number">0</span>,<span class="string">"drag"</span> =&gt; <span class="number">1</span>,<span class="string">"load"</span> =&gt; <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// topLevelEventsToReactNames：原生事件和合成事件的映射 Map结构</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"cancel"</span> =&gt; <span class="string">"onCancel"</span>,<span class="string">"click"</span> =&gt; <span class="string">"onClick"</span>,<span class="string">"close"</span> =&gt; <span class="string">"onClose"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// allNativeEvents：所有有意义的原生事件名称集合 Set结构</span></span><br><span class="line">&#123;<span class="string">'cancel'</span>, <span class="string">'click'</span>, <span class="string">'close'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// registrationNameDependencies：合成事件和其依赖的原生事件集合的映射</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"onCancel"</span>: [<span class="string">"cancel"</span>],</span><br><span class="line">  <span class="string">"onCancelCapture"</span>: [<span class="string">"cancel"</span>],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="string">"onChange"</span>: [<span class="string">"change"</span>, <span class="string">"click"</span>, <span class="string">"focusin"</span>,<span class="string">"focusout"</span>, <span class="string">"input"</span>, <span class="string">"keydown"</span>, <span class="string">"keyup"</span>, <span class="string">"selectionchange"</span>],</span><br><span class="line">  <span class="string">"onCancelCapture"</span>: [<span class="string">"change"</span>, <span class="string">"click"</span>, <span class="string">"focusin"</span>,<span class="string">"focusout"</span>, <span class="string">"input"</span>, <span class="string">"keydown"</span>, <span class="string">"keyup"</span>, <span class="string">"selectionchange"</span>],</span><br><span class="line">  <span class="string">"onSelect"</span>: [<span class="string">"focusout"</span>, <span class="string">"contextmenu"</span>, <span class="string">"dragend"</span>, <span class="string">"focusin"</span>, <span class="string">"keydown"</span>, <span class="string">"keyup"</span>, <span class="string">"mousedown"</span>, <span class="string">"mouseup"</span>, <span class="string">"selectionchange"</span>],</span><br><span class="line">  <span class="string">"onSelectCapture"</span>: [<span class="string">"focusout"</span>, <span class="string">"contextmenu"</span>, <span class="string">"dragend"</span>, <span class="string">"focusin"</span>, <span class="string">"keydown"</span>, <span class="string">"keyup"</span>, <span class="string">"mousedown"</span>, <span class="string">"mouseup"</span>, <span class="string">"selectionchange"</span>],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>事件的优先级：<br>DiscreteEvent：离散事件，cancel、click、mousedown 这类单点触发不持续的事件，优先级最低<br>UserBlockingEvent：用户阻塞事件，drag、mousemove、wheel 这类持续触发的事件，优先级相对较高<br>ContinuousEvent：连续事件，load、error、waiting 这类大多与媒体相关的事件为主的事件需要及时响应，所以优先级最高</p>
<p>所以事件优先级：ContinuousEvent &gt; UserBlockingEvent &gt; DiscreteEvent</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SimpleEventPlugin.registerEvents();</span><br><span class="line">EnterLeaveEventPlugin.registerEvents();</span><br><span class="line">ChangeEventPlugin.registerEvents();</span><br><span class="line">SelectEventPlugin.registerEvents();</span><br><span class="line">BeforeInputEventPlugin.registerEvents();</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/facebook/react/blob/main/packages/react-dom/src/events/DOMPluginEventSystem.js" target="_blank" rel="noopener">源码地址</a></p>
<center><img src="事件注册.png" width="20%" /></center>


<h5 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h5><p>获取应用中的所有原生事件，添加到监听器中，且添加带有优先级的事件处理器。</p>
<p><a href="https://github.com/facebook/react/blob/main/packages/react-dom/src/events/DOMPluginEventSystem.js" target="_blank" rel="noopener">源码地址</a></p>
<center><img src="事件绑定.png" width="70%" /></center>


<h5 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h5><p>触发某事件，触发对应的事件处理器如：DispatchDiscreteEvent (离散事件处理器)，从整个对于调用过程的进行追踪可以大致得到以下流程。</p>
<p><a href="https://github.com/facebook/react/blob/main/packages/react-dom/src/events/ReactDOMEventListener.js" target="_blank" rel="noopener">源码地址</a></p>
<center><img src="事件分发.png" width="70%" /></center>

<h3 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h3><p>1、DispatchEvent 是整个事件系统的核心，包含事件的注册、存储和执行；<br>2、React 事件系统通过代理统一的事件触发，来调度原生事件的触发；<br>3、React 事件系统的合成事件优先级影响着触发更新的优先级，决定了对应更新的更新时机；</p>
<h3 id="五、参考资料"><a href="#五、参考资料" class="headerlink" title="五、参考资料"></a>五、参考资料</h3><p><a href="https://www.yingpengsha.com/react-he-cheng-shi-jian-xi-tong-yuan-ma-jie-xi/" target="_blank" rel="noopener">React17 事件系统</a><br><a href="https://zh-hans.reactjs.org/blog/2020/08/10/react-v17-rc.html" target="_blank" rel="noopener">React更新日志</a><br><a href="https://juejin.cn/post/6863266370411298823#heading-7" target="_blank" rel="noopener">React16.x 版本的事件系统</a></p>
</div><div class="tags"><a href="/tags/react/"><i class="fa fa-tag"></i>react</a><a href="/tags/event/"><i class="fa fa-tag"></i>event</a></div><div class="post-nav"><a class="pre" href="/2021/12/02/Redux%E6%B5%85%E6%9E%90/">Redux 浅析</a><a class="next" href="/2021/07/21/ReactDiff%E6%B5%85%E6%9E%90/">React Diff 浅析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://qiuysh.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web%E6%8A%80%E6%9C%AF/">web技术</a><span class="category-list-count">30</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/gulp/" style="font-size: 15px;">gulp</a> <a href="/tags/webgl/" style="font-size: 15px;">webgl</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/babel/" style="font-size: 15px;">babel</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 15px;">浏览器</a> <a href="/tags/FormData/" style="font-size: 15px;">FormData</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/react%E3%80%81lifecycle/" style="font-size: 15px;">react、lifecycle</a> <a href="/tags/Redux/" style="font-size: 15px;">Redux</a> <a href="/tags/event/" style="font-size: 15px;">event</a> <a href="/tags/diff/" style="font-size: 15px;">diff</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/g6/" style="font-size: 15px;">g6</a> <a href="/tags/react-app-rewired/" style="font-size: 15px;">react-app-rewired</a> <a href="/tags/create-react-app/" style="font-size: 15px;">create-react-app</a> <a href="/tags/babe/" style="font-size: 15px;">babe</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/AST/" style="font-size: 15px;">AST</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/transform/" style="font-size: 15px;">transform</a> <a href="/tags/nrm/" style="font-size: 15px;">nrm</a> <a href="/tags/yarn/" style="font-size: 15px;">yarn</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/Fiber/" style="font-size: 15px;">Fiber</a> <a href="/tags/components/" style="font-size: 15px;">components</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/12/02/Redux%E6%B5%85%E6%9E%90/">Redux 浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/13/React%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F/">React 事件系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/21/ReactDiff%E6%B5%85%E6%9E%90/">React Diff 浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/09/React%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1/">React 源码结构设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/02/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/">浏览器缓存机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/23/nginx%E5%85%A5%E9%97%A8/">Nginx 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/15/babel%E4%B9%8Bast/">Babel 之 AST</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/12/babel%E6%8F%92%E4%BB%B6%E6%B5%85%E6%9E%90/">Babel 插件浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/babel%E7%9A%84%E8%AE%A4%E7%9F%A5%E7%AF%87/">Babel 的认知篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/07/%E6%B5%85%E8%B0%88js%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">浅谈 JS 异步编程</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">吾林の手扎.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>